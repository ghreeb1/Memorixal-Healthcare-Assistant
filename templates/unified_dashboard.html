<!DOCTYPE html>
<!-- The lang and dir attributes will be managed by JavaScript -->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ­ÙŠØ©</title>
    
    <!-- Google Fonts: Cairo for Arabic, Poppins for English -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- NEW: Marked.js library to render professional Markdown from Gemini -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            /* Modern Healthcare Color Palette - Matching Patient Interface */
            --primary-color: #0ea5e9;
            --primary-hover: #0284c7;
            --primary-light: #e0f2fe;
            --secondary-color: #64748b;
            --accent-color: #10b981;
            --accent-hover: #059669;
            --success-color: #059669;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            
            /* Background & Surface Colors */
            --background-color: #f8fafc;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --card-bg-color: #ffffff;
            --card-hover: #fefefe;
            
            /* Text Colors */
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-light: #f8fafc;
            --text-muted: #94a3b8;
            
            /* Border & Shadow */
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Layout */
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --border-radius-lg: 24px;
            
            /* Transitions */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Legacy compatibility */
            --shadow: var(--shadow-lg);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        html[lang="ar"] body { 
            font-family: 'Cairo', sans-serif; 
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 24px;
            background: var(--card-bg-color);
            padding: 32px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            position: relative;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }
        
        .header-title h1 { 
            font-size: 32px; 
            margin: 0; 
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-title p { 
            margin: 8px 0 0; 
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
        }
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
        }

        .btn { 
            padding: 14px 24px; 
            border: none; 
            border-radius: var(--border-radius); 
            font-weight: 600; 
            font-size: 14px; 
            cursor: pointer; 
            transition: var(--transition-fast); 
            text-decoration: none; 
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); 
            color: var(--text-light); 
            box-shadow: var(--shadow-md);
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-lg);
        }
        .btn-secondary { 
            background: var(--card-bg-color); 
            color: var(--primary-color); 
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .btn-secondary:hover { 
            border-color: var(--primary-color); 
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .card { 
            background: var(--card-bg-color); 
            border-radius: var(--border-radius-lg); 
            box-shadow: var(--shadow-lg); 
            padding: 32px;
            border: 1px solid var(--border-light);
            transition: var(--transition-fast);
        }
        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }
        html[lang="ar"] .card { 
            padding: 32px 40px; 
        }

        .metrics-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 24px; 
            margin-bottom: 40px; 
        }
        .metric-card { 
            display: flex; 
            align-items: center; 
            gap: 20px;
            position: relative;
        }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }
        .metric-card .icon-wrapper { 
            width: 64px; 
            height: 64px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, var(--primary-light), rgba(16, 185, 129, 0.1)); 
            color: var(--primary-color); 
            font-size: 24px; 
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }
        .metric-info .value { 
            font-size: 36px; 
            font-weight: 700; 
            margin: 0; 
            line-height: 1;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .metric-info .label { 
            margin: 8px 0 0; 
            color: var(--text-secondary); 
            font-size: 14px;
            font-weight: 500;
        }

        .main-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 24px; 
        }
        .main-grid > .card { 
            padding: 32px; 
        }

        .card-header { 
            font-size: 20px; 
            font-weight: 700; 
            margin-bottom: 24px; 
            display: flex; 
            align-items: center;
            color: var(--text-primary);
            position: relative;
            padding-bottom: 12px;
        }
        .card-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }
        .card-header i { 
            color: var(--primary-color);
            font-size: 22px;
        }
        html[dir="ltr"] .card-header i { 
            margin-right: 12px; 
        }
        html[dir="rtl"] .card-header i { 
            margin-left: 12px; 
        }
        .loading-text { 
            color: var(--text-secondary); 
            text-align: center; 
            padding: 48px 0;
            font-style: italic;
        }
        
        #activity-container .activity-item { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            padding: 20px; 
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition-fast);
            border-radius: var(--border-radius);
            margin: 0 -16px;
            background: var(--card-bg-color);
        }
        #activity-container .activity-item:last-child { 
            border-bottom: none; 
        }
        #activity-container .activity-item:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        #activity-container .activity-item .name { 
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }
        #activity-container .activity-item .info { 
            font-size: 14px; 
            color: var(--text-secondary);
            font-weight: 500;
        }
        #activity-container .activity-item .icon { 
            font-size: 20px; 
            color: var(--primary-color);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-light);
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Real-time activity indicators */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .activity-item.active {
            border: 2px solid var(--accent-color) !important;
            background: rgba(16, 185, 129, 0.1) !important;
            box-shadow: var(--shadow-md);
        }

        .activity-item.completed {
            background: rgba(16, 185, 129, 0.05) !important;
            transition: background-color 2s ease;
        }

        .progress-indicator {
            animation: pulse 2s infinite;
            background: var(--accent-color) !important;
            color: var(--text-light) !important;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Styles for content rendered from Markdown */
        .markdown-content h3 { 
            font-size: 18px; 
            margin-top: 20px; 
            margin-bottom: 12px; 
            color: var(--text-primary);
            font-weight: 600;
        }
        .markdown-content p { 
            margin-top: 0; 
            margin-bottom: 16px; 
            line-height: 1.6;
            color: var(--text-primary);
        }
        .markdown-content ul { 
            padding-left: 24px; 
            margin-top: 0; 
            margin-bottom: 16px; 
        }
        .markdown-content li { 
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        html[dir="rtl"] .markdown-content ul { 
            padding-left: 0; 
            padding-right: 24px; 
        }
        
        #report-text-area { 
            background: var(--background-color); 
            border: 2px solid var(--border-color); 
            border-radius: var(--border-radius); 
            padding: 24px; 
            min-height: 200px; 
            margin-top: 20px; 
            color: var(--text-primary); 
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) { 
            .main-grid { 
                grid-template-columns: repeat(2, 1fr); 
            } 
            #patient-activity-card { 
                grid-column: 1 / -1; 
            }
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 820px) { 
            .main-grid { 
                grid-template-columns: 1fr; 
            }
            .dashboard-container {
                padding: 20px 16px;
            }
            .dashboard-header {
                padding: 24px;
                margin-bottom: 32px;
            }
            .header-title h1 {
                font-size: 28px;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            .main-grid {
                gap: 20px;
            }
            .card {
                padding: 24px;
            }
            .header-actions {
                flex-direction: column;
                gap: 12px;
                width: 100%;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-header {
                padding: 20px;
            }
            .header-title h1 {
                font-size: 24px;
            }
            .metric-info .value {
                font-size: 28px;
            }
            .metric-card .icon-wrapper {
                width: 56px;
                height: 56px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        
        <header class="dashboard-header">
            <div class="header-title">
                <h1 data-lang-key="dashboardTitle">Health Dashboard</h1>
                <p data-lang-key="dashboardSubtitle">Welcome, here are the latest patient updates.</p>
            </div>
            <div class="header-actions">
                <button id="language-switcher" class="btn btn-secondary" data-lang-key="langSwitchBtn">Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                <a href="/role-selection" class="btn btn-primary" data-lang-key="backButton">Back to Role Selection</a>
            </div>
        </header>

        <main class="dashboard-content">
            <section class="metrics-grid">
                <div class="card metric-card">
                    <div class="icon-wrapper"><i class="fas fa-list-check"></i></div>
                    <div class="metric-info">
                        <p class="value" id="total-sessions">-</p>
                        <p class="label" data-lang-key="metricTodaySessions">Today's Sessions</p>
                    </div>
                </div>
                <div class="card metric-card">
                    <div class="icon-wrapper"><i class="fas fa-calendar-alt"></i></div>
                    <div class="metric-info">
                        <p class="value" id="weekly-sessions">-</p>
                        <p class="label" data-lang-key="metricWeeklySessions">Weekly Sessions</p>
                    </div>
                </div>
                <div class="card metric-card">
                    <div class="icon-wrapper"><i class="fas fa-star"></i></div>
                    <div class="metric-info">
                        <p class="value" id="avg-score">-</p>
                        <p class="label" data-lang-key="metricAvgScore">Avg. Score</p>
                    </div>
                </div>
                <div class="card metric-card">
                    <div class="icon-wrapper"><i class="fas fa-heart-pulse"></i></div>
                    <div class="metric-info">
                        <p class="value" id="health-status">-</p>
                        <p class="label" data-lang-key="metricHealthStatus">Health Status</p>
                    </div>
                </div>
            </section>

            <section class="main-grid">
                <div class="card" id="patient-activity-card">
                    <h2 class="card-header"><i class="fas fa-chart-line"></i><span data-lang-key="activityTitle">Patient Activity Overview</span></h2>
                    <div id="activity-container" class="loading-text" data-lang-key="loadingActivities">Loading patient activities...</div>
                </div>
                <div class="card" id="ai-insights-card">
                    <h2 class="card-header"><i class="fas fa-brain"></i><span data-lang-key="insightsTitle">AI Health Insights</span></h2>
                    <div id="insights-container" class="loading-text markdown-content" data-lang-key="loadingInsights">Analyzing patient data...</div>
                </div>
                <div class="card" id="report-card">
                    <h2 class="card-header"><i class="fas fa-file-alt"></i><span data-lang-key="reportTitle">Healthcare Progress Report</span></h2>
                    <button id="generate-report-btn" class="btn btn-primary" style="width: 100%;"><i class="fas fa-cogs"></i><span data-lang-key="generateReportBtn">Generate Comprehensive Report</span></button>
                    <div id="report-text-area" class="markdown-content" data-lang-key="reportPlaceholder">Press the button above to generate the report.</div>
                </div>
            </section>
        </main>
    </div>

<script>
class HealthcareDashboard {
    constructor() {
        this.apiBase = window.location.origin;
        this.patientId = new URLSearchParams(window.location.search).get('patientId') || '1';
        this.currentLanguage = 'en';
        this.websocket = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectDelay = 3000; // 3 seconds
        this.translations = {
             en: {
                dashboardTitle: "Health Dashboard", dashboardSubtitle: "Welcome, here are the latest patient updates.",
                langSwitchBtn: "Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", backButton: "Back to Role Selection",
                metricTodaySessions: "Today's Sessions", metricWeeklySessions: "Weekly Sessions",
                metricAvgScore: "Avg. Score", metricHealthStatus: "Health Status",
                activityTitle: "Patient Activity Overview", insightsTitle: "AI Health Insights",
                reportTitle: "Healthcare Progress Report", generateReportBtn: "Generate Comprehensive Report",
                reportPlaceholder: "Press the button above to generate the report.",
                loadingActivities: "Loading patient activities...", loadingInsights: "Analyzing patient data...",
                lastUsed: "Last used", sessions: "Sessions", score: "Score", noActivities: "No recent activities found.",
                noInsights: "No AI insights available yet.",
                statusExcellent: "Excellent", statusGood: "Good", statusNeedsAttention: "Needs Attention", statusNoData: "No Data",
                generatingReport: "Generating report, please wait...", failedToGenerate: "Failed to generate report."
             },
             ar: {
                dashboardTitle: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ­ÙŠØ©", dashboardSubtitle: "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø¥Ù„ÙŠÙƒ Ø¢Ø®Ø± Ø§Ù„Ù…Ø³ØªØ¬Ø¯Ø§Øª Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶.",
                langSwitchBtn: "Switch to English", backButton: "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±",
                metricTodaySessions: "Ø¬Ù„Ø³Ø§Øª Ø§Ù„ÙŠÙˆÙ…", metricWeeklySessions: "Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©",
                metricAvgScore: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ù‚Ø§Ø·", metricHealthStatus: "Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©",
                activityTitle: "Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ÙŠØ¶", insightsTitle: "Ø±Ø¤Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
                reportTitle: "ØªÙ‚Ø±ÙŠØ± ØªÙ‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ©", generateReportBtn: "Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„",
                reportPlaceholder: "Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.",
                loadingActivities: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø±ÙŠØ¶...", loadingInsights: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶...",
                lastUsed: "Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…", sessions: "Ø¬Ù„Ø³Ø§Øª", score: "Ø§Ù„Ù†Ù‚Ø§Ø·", noActivities: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ù…Ø³Ø¬Ù„Ø© Ù…Ø¤Ø®Ø±Ø§Ù‹.",
                noInsights: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¤Ù‰ Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯.",
                statusExcellent: "Ù…Ù…ØªØ§Ø²Ø©", statusGood: "Ø¬ÙŠØ¯Ø©", statusNeedsAttention: "ØªØ­ØªØ§Ø¬ Ø§Ù†ØªØ¨Ø§Ù‡", statusNoData: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª",
                generatingReport: "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...", failedToGenerate: "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±."
            }
        };
        this.init();
    }

    init() {
        this.setLanguage(this.currentLanguage);
        this.loadAllData();
        this.setupEventListeners();
        this.initWebSocket();
    }

    initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/dashboard`;
        
        try {
            this.websocket = new WebSocket(wsUrl);
            
            this.websocket.onopen = () => {
                console.log('Dashboard WebSocket connected');
                this.reconnectAttempts = 0;
                this.showConnectionStatus('connected');
            };
            
            this.websocket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    this.handleWebSocketMessage(message);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            this.websocket.onclose = () => {
                console.log('Dashboard WebSocket disconnected');
                this.showConnectionStatus('disconnected');
                this.attemptReconnect();
            };
            
            this.websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                this.showConnectionStatus('error');
            };
        } catch (error) {
            console.error('Failed to initialize WebSocket:', error);
            this.showConnectionStatus('error');
        }
    }

    attemptReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            console.log(`Attempting to reconnect WebSocket (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
            setTimeout(() => {
                this.initWebSocket();
            }, this.reconnectDelay);
        } else {
            console.error('Max WebSocket reconnection attempts reached');
            this.showConnectionStatus('failed');
        }
    }

    showConnectionStatus(status) {
        // Add a small connection indicator to the header
        let indicator = document.getElementById('connection-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'connection-indicator';
            indicator.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                padding: 8px 16px; border-radius: 20px; 
                font-size: 12px; font-weight: 600; z-index: 1000;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            document.body.appendChild(indicator);
        }
        
        switch (status) {
            case 'connected':
                indicator.textContent = 'ðŸŸ¢ Live Updates Active';
                indicator.style.background = '#10b981';
                indicator.style.color = 'white';
                break;
            case 'disconnected':
                indicator.textContent = 'ðŸŸ¡ Reconnecting...';
                indicator.style.background = '#f59e0b';
                indicator.style.color = 'white';
                break;
            case 'error':
            case 'failed':
                indicator.textContent = 'ðŸ”´ Connection Failed';
                indicator.style.background = '#ef4444';
                indicator.style.color = 'white';
                break;
        }
    }

    handleWebSocketMessage(message) {
        console.log('Received WebSocket message:', message);
        
        if (message.type === 'dashboard_update') {
            // Handle real-time dashboard updates
            if (message.patient_id === this.patientId) {
                this.handlePatientUpdate(message);
            }
        } else if (message.type === 'connection_established') {
            console.log('WebSocket connection established:', message.message);
        }
    }

    handlePatientUpdate(message) {
        const { update_type, data } = message;
        
        switch (update_type) {
            case 'activity_started':
                this.showActivityNotification(`Started: ${data.activity_type}`, 'info');
                // Immediately update the activity overview
                this.updateActivityInRealTime(data.activity_type, 'started');
                // Refresh all data to show updated metrics
                setTimeout(() => this.loadAllData(), 1000);
                break;
                
            case 'activity_ended':
            case 'activity_completed':
                const duration = data.duration_seconds || data.metadata?.duration || 0;
                const score = data.score || data.metadata?.score;
                this.showActivityNotification(
                    `Completed: ${data.activity_type} (${Math.round(duration / 60)}min${score ? `, Score: ${score}` : ''})`, 
                    'success'
                );
                // Immediately update the activity overview
                this.updateActivityInRealTime(data.activity_type, 'completed', { duration, score });
                // Refresh all data to show updated metrics
                setTimeout(() => this.loadAllData(), 1000);
                break;
                
            default:
                console.log('Unknown update type:', update_type, data);
                // Still refresh data for unknown update types
                this.loadAllData();
        }
    }

    updateActivityInRealTime(activityType, action, metadata = {}) {
        // Find the activity card and update it immediately
        const container = document.getElementById('activity-container');
        if (!container) return;

        const activityItems = container.querySelectorAll('.activity-item');
        
        activityItems.forEach(item => {
            const nameElement = item.querySelector('.name');
            if (!nameElement) return;
            
            // Check if this is the activity being updated
            const activityName = nameElement.textContent.toLowerCase();
            const typeMap = {
                'games': ['mind games', 'games'],
                'caregiver': ['personal caregiver', 'caregiver', 'chat'],
                'stories': ['memory storytelling', 'storytelling', 'stories'],
                'breathing': ['relaxation breathing', 'breathing', 'relaxation'],
                'aiart': ['ai art therapy', 'art therapy', 'ai art']
            };
            
            const matchingTypes = typeMap[activityType] || [activityType];
            const isMatch = matchingTypes.some(type => activityName.includes(type.toLowerCase()));
            
            if (isMatch) {
                const infoElement = item.querySelector('.info');
                if (infoElement && action === 'started') {
                    // Add a visual indicator that activity is in progress
                    item.style.border = '2px solid #10b981';
                    item.style.backgroundColor = '#f0fdf4';
                    
                    // Add "In Progress" indicator
                    const progressIndicator = document.createElement('span');
                    progressIndicator.className = 'progress-indicator';
                    progressIndicator.style.cssText = `
                        display: inline-block;
                        background: #10b981;
                        color: white;
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 0.75rem;
                        margin-left: 8px;
                        animation: pulse 2s infinite;
                    `;
                    progressIndicator.textContent = 'ðŸ”„ Active';
                    
                    // Remove any existing progress indicator
                    const existingIndicator = item.querySelector('.progress-indicator');
                    if (existingIndicator) existingIndicator.remove();
                    
                    infoElement.appendChild(progressIndicator);
                    
                } else if (infoElement && action === 'completed') {
                    // Remove progress styling
                    item.style.border = '';
                    item.style.backgroundColor = '';
                    
                    // Remove progress indicator
                    const progressIndicator = item.querySelector('.progress-indicator');
                    if (progressIndicator) progressIndicator.remove();
                    
                    // Add completion flash
                    item.style.backgroundColor = '#dcfce7';
                    setTimeout(() => {
                        item.style.backgroundColor = '';
                    }, 2000);
                    
                    // Update last used time immediately
                    const now = new Date();
                    const timeString = now.toLocaleString();
                    infoElement.innerHTML = infoElement.innerHTML.replace(
                        /Last used: [^|]+/,
                        `Last used: ${timeString}`
                    );
                }
            }
        });
    }

    showActivityNotification(message, type = 'info') {
        // Create a toast notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 80px; right: 20px; 
            padding: 16px 24px; border-radius: 16px; 
            font-weight: 600; z-index: 1001;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
        `;
        
        const colors = {
            info: { bg: '#0ea5e9', text: 'white' },
            success: { bg: '#10b981', text: 'white' },
            warning: { bg: '#f59e0b', text: 'white' }
        };
        
        const color = colors[type] || colors.info;
        notification.style.background = color.bg;
        notification.style.color = color.text;
        notification.textContent = `ðŸ“Š ${message}`;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // Remove after 4 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }
    
    setLanguage(lang) {
        this.currentLanguage = lang;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        document.title = this.translations[lang].dashboardTitle;
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            el.textContent = this.translations[lang][key] || el.textContent;
        });
        this.loadAllData();
    }
    
    async fetchData(endpoint, options = {}) {
        try {
            const response = await fetch(`${this.apiBase}${endpoint}`, options);
            if (!response.ok) throw new Error(`Network response error, status: ${response.status}`);
            return response.json();
        } catch (error) {
            console.error(`Fetch error for ${endpoint}:`, error);
            return { status: 'error', message: error.message };
        }
    }
    
    async loadAllData() {
        const [dashboardData, activityData, insightsData] = await Promise.all([
            this.fetchData(`/api/v1/patients/${this.patientId}/dashboard`),
            this.fetchData(`/api/v1/patients/${this.patientId}/activities`),
            this.fetchData(`/api/v1/patients/${this.patientId}/ai-insights`)
        ]);

        if (dashboardData && dashboardData.status === 'success') this.updateMetrics(dashboardData);
        if (activityData && activityData.status === 'success') this.renderActivityCards(activityData.activities); else this.renderError('activity-container');
        if (insightsData && insightsData.status === 'success') this.renderAIInsights(insightsData); else this.renderError('insights-container');
    }

    updateMetrics(data) {
        const todaySessions = (data.daily_chats || 0) + (data.games_played || 0) + (data.memory_responses || 0);
        document.getElementById('total-sessions').textContent = todaySessions;
        
        const lang = this.currentLanguage;
        if (data.weekly_stats) {
            document.getElementById('weekly-sessions').textContent = data.weekly_stats.total_sessions || '0';
            document.getElementById('avg-score').textContent = data.weekly_stats.avg_score ? `${Math.round(data.weekly_stats.avg_score)}` : '-';
            const { avg_score, total_sessions } = data.weekly_stats;
            const statusEl = document.getElementById('health-status');
            if (!avg_score || total_sessions === 0) statusEl.textContent = this.translations[lang].statusNoData;
            else if (avg_score >= 75 && total_sessions >= 10) statusEl.textContent = this.translations[lang].statusExcellent;
            else if (avg_score >= 60 && total_sessions >= 5) statusEl.textContent = this.translations[lang].statusGood;
            else statusEl.textContent = this.translations[lang].statusNeedsAttention;
        } else {
            document.getElementById('health-status').textContent = this.translations[lang].statusNoData;
        }
    }

    renderActivityCards(activities) {
        const container = document.getElementById('activity-container');
        const lang = this.currentLanguage;
        
        // **FIX**: Removed the filter for 'caregiver' to show the chat feature.
        const visible = (activities || []).filter(a => a.id !== 'dashboard');

        if (visible.length === 0) {
            container.textContent = this.translations[lang].noActivities;
            container.classList.add('loading-text');
            return;
        }
        
        container.classList.remove('loading-text');
        container.innerHTML = visible.map(activity => `
            <div class="activity-item">
                <i class="${activity.icon || 'fas fa-question-circle'} icon"></i>
                <div class="details">
                    <div class="name">${activity.name}</div>
                    <div class="info">
                        ${this.translations[lang].lastUsed}: ${activity.last_used} | 
                        ${this.translations[lang].sessions}: ${activity.total_sessions} | 
                        ${this.translations[lang].score}: ${activity.avg_score || 'N/A'}
                    </div>
                </div>
            </div>
        `).join('');
    }

    renderAIInsights(data) {
        const container = document.getElementById('insights-container');
        const lang = this.currentLanguage;
        
        if (!data || !data.summary) {
            container.innerHTML = this.translations[lang].noInsights;
            container.classList.add('loading-text');
            return;
        }

        container.classList.remove('loading-text');
        container.style.textAlign = 'start';
        // **IMPROVEMENT**: Use marked.parse to render Markdown professionally
        container.innerHTML = marked.parse(data.summary);
    }
    
    async generateReport() {
        const reportArea = document.getElementById('report-text-area');
        reportArea.innerHTML = this.translations[this.currentLanguage].generatingReport;
        
        try {
            const options = { method: 'POST', headers: { 'Content-Type': 'application/json' } };
            const data = await this.fetchData('/api/report', options);
            
            if (data && data.status === 'success') {
                // **IMPROVEMENT**: Use marked.parse to render Markdown professionally
                reportArea.innerHTML = marked.parse(data.report);
            } else {
                throw new Error(data.message || 'Failed to generate report');
            }
        } catch (error) {
            console.error("Error generating report:", error);
            reportArea.innerHTML = this.translations[this.currentLanguage].failedToGenerate;
        }
    }

    renderError(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            container.textContent = 'Failed to load data. Please refresh.';
            container.style.color = '#E53E3E'; // Error color
        }
    }

    setupEventListeners() {
        document.getElementById('language-switcher').addEventListener('click', () => {
            const newLang = this.currentLanguage === 'en' ? 'ar' : 'en';
            this.setLanguage(newLang);
        });
        document.getElementById('generate-report-btn').addEventListener('click', () => this.generateReport());
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new HealthcareDashboard();
});
</script>

</body>
</html>